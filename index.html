<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數據航海王 - 企業戰情室</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div id="app" v-cloak>
        <nav class="navbar navbar-expand-lg navbar-dark bg-glass-dark sticky-top">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold" href="#">
                    <i class="fas fa-ship me-2 text-info"></i>數據航海王 <span class="badge bg-danger rounded-pill fs-7">Pro</span>
                </a>
                <span class="navbar-text text-light opacity-75">團隊：我要成為海賊王</span>
            </div>
        </nav>

        <div class="container-fluid mt-4">
            <div class="row">
                <div class="col-lg-3 mb-4">
                    <div class="card shadow-lg border-0 h-100 sidebar-card">
                        <div class="card-header bg-transparent border-0 pt-4 pb-2">
                            <h5 class="fw-bold text-primary"><i class="fas fa-sliders-h me-2"></i>控制中心</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <label class="form-label text-muted small fw-bold">API KEY 設定</label>
                                <input type="password" class="form-control form-control-lg bg-light border-0" v-model="apiKey" placeholder="貼上 Google API Key">
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label text-muted small fw-bold">AI 模型引擎</label>
                                <select class="form-select form-select-lg bg-light border-0" v-model="selectedModel">
                                    <option value="gemini-3-pro-preview">gemini-3-pro-preview</option>
                                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label text-muted small fw-bold">上傳財報數據 (CSV)</label>
                                <div class="upload-box p-4 text-center border rounded bg-light" @click="$refs.fileInput.click()">
                                    <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                                    <p class="mb-0 text-muted small" v-if="!fileName">點擊上傳檔案</p>
                                    <p class="mb-0 text-success fw-bold small" v-else>{{ fileName }}</p>
                                    <input type="file" ref="fileInput" class="d-none" @change="handleFileUpload">
                                </div>
                            </div>
                            
                            <div class="d-grid">
                                <button class="btn btn-outline-danger rounded-pill" @click="resetSystem"><i class="fas fa-redo-alt me-1"></i> 重置系統</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-9">
                    <div class="card shadow-lg border-0 main-card">
                        <div class="card-header bg-white border-0 pt-3 pb-0">
                            <ul class="nav nav-tabs card-header-tabs border-0">
                                <li class="nav-item"><a class="nav-link px-4 py-2 fw-bold" :class="{ active: currentTab === 'chat' }" href="#" @click.prevent="currentTab = 'chat'"><i class="fas fa-comments me-2"></i>AI 助理</a></li>
                                <li class="nav-item"><a class="nav-link px-4 py-2 fw-bold" :class="{ active: currentTab === 'executive' }" href="#" @click.prevent="currentTab = 'executive'"><i class="fas fa-chart-pie me-2"></i>Multi Stage</a></li>
                            </ul>
                        </div>

                        <div class="card-body bg-light-gray p-4">
                            
                            <div v-if="currentTab === 'chat'" class="h-100 d-flex flex-column">
                                <div class="chat-box flex-grow-1 p-3 mb-3 bg-white rounded shadow-sm" id="chatBox">
                                    <div v-for="(msg, index) in chatHistory" :key="index" class="message-row mb-3 d-flex" :class="msg.role">
                                        <div class="avatar me-2" v-if="msg.role === 'ai'">
                                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;"><i class="fas fa-robot"></i></div>
                                        </div>
                                        <div class="message-bubble p-3 rounded-4 shadow-sm" :class="msg.role === 'user' ? 'bg-primary text-white ms-auto' : 'bg-light text-dark'">
                                            <div v-html="renderMarkdown(msg.content)"></div>
                                            <small class="opacity-50 mt-1 d-block" style="font-size: 0.7rem;" v-if="msg.role === 'ai'">{{ msg.model }}</small>
                                        </div>
                                    </div>
                                    <div v-if="loading" class="text-center mt-4"><div class="typing-indicator"><span></span><span></span><span></span></div></div>
                                </div>
                                <div class="input-group input-group-lg shadow-sm">
                                    <input type="text" class="form-control border-0" v-model="userInput" @keyup.enter="sendMessage" placeholder="輸入問題...">
                                    <button class="btn btn-primary px-4" @click="sendMessage"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>

                            <div v-else class="h-100">
                                <div class="dashboard-header bg-white p-4 rounded-4 shadow-sm mb-4">
                                    <h4 class="fw-bold mb-3 text-dark">Multi Stage Analysis</h4>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-light border-0"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control bg-light border-0" v-model="executiveInput" @keyup.enter="startExecutiveAnalysis(false)" placeholder="例如：分析 2024 年 Q3 的利潤下滑原因...">
                                        <button class="btn btn-primary px-5 fw-bold rounded-end" @click="startExecutiveAnalysis(false)" :disabled="isAnalyzing">
                                            <span v-if="!isAnalyzing">啟動分析</span>
                                            <span v-else>分析中...</span>
                                        </button>
                                    </div>
                                    <div v-if="isAnalyzing || currentStep > 0" class="mt-3">
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-gradient-primary" role="progressbar" :style="{width: progressWidth + '%' }"></div>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0"><i class="fas fa-sync fa-spin me-1" v-if="isAnalyzing"></i> {{ progressText }}</p>
                                    </div>
                                </div>

                                <div class="row g-4 justify-content-center">
                                    <div class="col-lg-10">

                                        <div v-for="(log, index) in meetingLogs" :key="index" class="mb-5 fade-in-up" style="opacity: 0.9;">
                                            <div class="text-center mb-4">
                                                <span class="badge bg-secondary rounded-pill px-3 py-1">歷史紀錄 #{{ index + 1 }} - {{ log.query }}</span>
                                            </div>

                                            <div class="card border-0 shadow-sm mb-4" v-if="log.chartJson">
                                                <div class="card-header bg-white border-bottom-0 pt-3">
                                                    <h6 class="fw-bold text-secondary"><i class="fas fa-history me-2"></i>歷史視覺化洞察</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div style="height: 300px; position: relative;">
                                                        <canvas :id="'history-chart-' + index"></canvas>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="card border-0 shadow-sm mb-3">
                                                <div class="card-header bg-white border-bottom-0 pt-3"><span class="badge bg-primary-subtle text-primary rounded-pill"><i class="fas fa-user-tie me-1"></i> CFO (歷史)</span></div>
                                                <div class="card-body"><div v-html="renderMarkdown(log.reports.cfo)"></div></div>
                                            </div>
                                            <div class="card border-0 shadow-sm mb-3" v-if="log.reports.coo">
                                                <div class="card-header bg-white border-bottom-0 pt-3"><span class="badge bg-success-subtle text-success rounded-pill"><i class="fas fa-cogs me-1"></i> COO (歷史)</span></div>
                                                <div class="card-body"><div v-html="renderMarkdown(log.reports.coo)"></div></div>
                                            </div>
                                            <div class="card border-0 shadow-sm border-start border-5 border-secondary">
                                                <div class="card-header bg-white border-bottom-0 pt-3"><span class="badge bg-secondary-subtle text-dark rounded-pill"><i class="fas fa-chess-king me-1"></i> CEO (歷史決策)</span></div>
                                                <div class="card-body"><div v-html="renderMarkdown(log.reports.ceo)"></div></div>
                                            </div>
                                            <hr class="my-5 border-2 opacity-10">
                                        </div>

                                        <div v-if="reports.cfo || isAnalyzing">
                                            
                                            <div class="card border-0 shadow-sm mb-4 fade-in-up" v-show="hasChartData">
                                                <div class="card-header bg-white border-bottom-0 pt-3">
                                                    <h6 class="fw-bold text-primary"><i class="fas fa-chart-bar me-2"></i>AI 視覺化洞察 (最新)</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div style="height: 300px; position: relative;">
                                                        <canvas id="dynamicChart"></canvas>
                                                    </div>
                                                    <p class="text-center text-muted small mt-2">{{ chartExplanation }}</p>
                                                </div>
                                            </div>

                                            <div class="card border-0 shadow-sm mb-4 bg-white fade-in-up" v-if="reports.ceo">
                                                <div class="card-body d-flex align-items-center justify-content-between p-4">
                                                    <div>
                                                        <h5 class="fw-bold mb-1">AI 風險評估指數</h5>
                                                        <p class="text-muted small mb-0">由 CEO 綜合財務與營運數據判讀</p>
                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                        <div class="risk-badge px-4 py-2 rounded-pill fw-bold text-white shadow-sm" :class="riskColorClass" style="font-size: 1.2rem;">
                                                            {{ riskScore }} / 100
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="card border-0 shadow-sm mb-3 fade-in-up" style="animation-delay: 0.1s;" v-if="reports.cfo">
                                                <div class="card-header bg-white border-bottom-0 pt-3">
                                                    <span class="badge bg-primary-subtle text-primary rounded-pill px-3 py-2"><i class="fas fa-user-tie me-1"></i> CFO 觀點</span>
                                                </div>
                                                <div class="card-body"><div v-html="renderMarkdown(reports.cfo)"></div></div>
                                            </div>

                                            <div class="card border-0 shadow-sm mb-3 fade-in-up" v-if="reports.coo" style="animation-delay: 0.2s;">
                                                <div class="card-header bg-white border-bottom-0 pt-3">
                                                    <span class="badge bg-success-subtle text-success rounded-pill px-3 py-2"><i class="fas fa-cogs me-1"></i> COO 觀點</span>
                                                </div>
                                                <div class="card-body"><div v-html="renderMarkdown(reports.coo)"></div></div>
                                            </div>

                                            <div class="card border-0 shadow-sm border-start border-5 border-warning fade-in-up" v-if="reports.ceo" style="animation-delay: 0.3s;">
                                                <div class="card-header bg-white border-bottom-0 pt-3">
                                                    <span class="badge bg-warning-subtle text-dark rounded-pill px-3 py-2"><i class="fas fa-chess-king me-1"></i> CEO 最終決策</span>
                                                </div>
                                                <div class="card-body"><div v-html="renderMarkdown(reports.ceo)"></div></div>
                                            </div>

                                            <div class="fade-in-up mt-4" v-if="reports.ceo && followUpQuestions.length > 0 && !isAnalyzing" style="animation-delay: 0.5s;">
                                                <h6 class="text-muted fw-bold mb-3"><i class="fas fa-lightbulb text-warning me-2"></i>繼續深入追問：</h6>
                                                <div class="row g-3">
                                                    <div class="col-md-4" v-for="(q, index) in followUpQuestions" :key="index">
                                                        <button class="btn btn-white border shadow-sm w-100 h-100 py-3 text-start position-relative hover-lift" @click="handleFollowUp(q)">
                                                            <span class="badge bg-light text-dark mb-2">議題 {{ index + 1 }}</span>
                                                            <p class="mb-0 fw-bold text-primary small">{{ q }}</p>
                                                            <i class="fas fa-arrow-down position-absolute bottom-0 end-0 m-3 text-muted opacity-25"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div v-else-if="!isAnalyzing && meetingLogs.length === 0" class="text-center py-5 mt-5 opacity-50">
                                            <i class="fas fa-chart-line fa-4x mb-3 text-muted"></i>
                                            <h5>準備好開始分析了嗎？</h5>
                                            <p>上傳 CSV 並輸入問題，AI 將自動決定最佳視覺化圖表。</p>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <style>
        [v-cloak] { display: none; }
    </style>
</body>
</html>